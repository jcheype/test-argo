metadata:
  name: demo
  namespace: argo
  labels:
    example: "true"
spec:
  arguments:
    parameters:
      - name: branch
        value: main
      - name: repo
        value: https://github.com/jcheype/test-argo.git
  entrypoint: main
  templates:
    - name: main
      steps:
        - - name: checkout
            template: checkout
        - - name: build
            template: build
        - - name: publish
            template: publish
            arguments:
              parameters:
                - name: commit_id
                  value: '{{steps.checkout.outputs.parameters.commit_id}}'
    - name: checkout
      script:
        image: node:24
        workingDir: /work
        args:
          - sh
        # use --depth 1 and --single-branch for fastest possible checkout
        source: git clone --depth 1 --single-branch --branch {{workflow.parameters.branch}} {{workflow.parameters.repo}} . && (git log --format="%H" -n 1 > commit)
        volumeMounts:
          - mountPath: /work
            name: work
      outputs:
        parameters:
          - name: commit_id
            valueFrom:
              path: commit
    - name: build
      script:
        image: node:24
        workingDir: /work
        args:
          - sh
        source: yarn install && yarn build
        volumeMounts:
          - mountPath: /work
            name: work
    - name: publish
      inputs:
        parameters:
          - name: commit_id
      script:
        image: gcr.io/kaniko-project/executor:latest
        workingDir: /workspace
        args:
          - --dockerfile
          - Dockerfile
          - --destination
          - registry.home.jcheype.com/test-app:{{inputs.parameters.commit_id}}
        volumeMounts:
          - mountPath: /workspace
            name: work
  volumeClaimTemplates:
    # A shared work volume.
    - name: work
      metadata:
        name: work
      spec:
        accessModes: [ "ReadWriteOnce" ]
        resources:
          requests:
            storage: 256Mi

